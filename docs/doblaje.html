<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronización de Audio con YouTube</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
        }
        #video-container { width: 100%; max-width: 800px; position: relative; }
        iframe { width: 100%; height: 450px; }
        #controls-container {
            position: sticky;
            bottom: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: center;
            padding: 10px;
            gap: 10px;
        }
        #timestamp { font-size: 1.5rem; font-weight: bold; margin-top: 10px; }
        .controls { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .controls button { padding: 10px; font-size: 16px; }
        #extra-controls { transition: opacity 0.3s; }
        #error-log { display: none; background: #ffcccc; padding: 10px; margin-top: 10px; border-radius: 5px; color: #cc0000; width: 80%; max-width: 800px; }
    </style>
</head>
<body>

<div id="video-container"></div>

<div id="controls-container">
    <button id="play-button" disabled>Reproducir</button>
    <button id="record-button" disabled>Grabar</button>
    <button id="stop-recording-button" disabled>Detener</button>
</div>

<h1>Sincronización de Audio con YouTube</h1>

<div id="extra-controls">
    <div class="controls">
        <label for="youtube-url">URL de YouTube:</label>
        <input type="text" id="youtube-url" placeholder="Pega la URL de YouTube aquí">
        <button id="load-video">Cargar Video</button>
        <div id="timestamp">0:00:00.000</div>
        <button id="generate-url-button">Generar URL con marcas de tiempo</button>
        <input type="text" id="generated-url" readonly>
        <button id="copy-errors-button">Copiar Errores</button>
    </div>
</div>

<div id="error-log"></div>

<script>
    let mediaRecorder, videoElement;
    let isRecording = false;
    let audioChunks = [];
    let hideExtraControls = false;

    function logTrace(message) {
        console.log(message);
        const errorLog = document.getElementById("error-log");
        errorLog.style.display = 'block';
        errorLog.textContent += `${new Date().toLocaleTimeString()}: ${message}\n`;
    }

    function getYouTubeVideoId(url) {
        const regExp = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }

    function loadYouTubeVideo(videoId, startTime) {
        if (!videoId) return logTrace("Error: ID de video no válido.");

        logTrace(`Cargando video con ID: ${videoId} y marca de tiempo: ${startTime}`);

        let videoContainer = document.getElementById("video-container");
        videoContainer.innerHTML = `<iframe id="video" src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&start=${startTime}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;

        videoElement = document.getElementById("video");

        document.getElementById("play-button").disabled = false;
        document.getElementById("record-button").disabled = false;

        videoElement.onload = () => {
            logTrace("Video cargado correctamente.");
        };

        // Detectar cuando el video termina para detener la grabación automáticamente
        window.addEventListener("message", function(event) {
            if (event.data === '{"event":"onStateChange","info":0}') {
                logTrace("El video ha terminado.");
                stopRecording();
            }
        }, false);
    }

    function handleVideoLoading() {
        const url = document.getElementById("youtube-url").value;
        const videoId = getYouTubeVideoId(url);
        const timeMatch = url.match(/[?&]t=(\d+)[m]?(\d+)?[s]?/);
        const startTime = timeMatch ? (parseInt(timeMatch[1]) || 0) + (parseInt(timeMatch[2] || 0) * 60) : 0;

        if (videoId) {
            loadYouTubeVideo(videoId, startTime);
        } else {
            logTrace("URL de YouTube no válida.");
        }
    }

    document.getElementById("load-video").addEventListener("click", handleVideoLoading);

    document.getElementById("record-button").addEventListener("click", async function () {
        if (isRecording) {
            logTrace("Ya hay una grabación en curso.");
            return;
        }

        if (!videoElement) {
            logTrace("Error: No hay un video cargado.");
            return;
        }

        try {
            logTrace("Solicitando permiso para el micrófono...");
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            logTrace("Permiso concedido. Iniciando grabación...");

            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                logTrace("Grabación detenida.");
                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                const audioUrl = URL.createObjectURL(audioBlob);

                const a = document.createElement("a");
                a.href = audioUrl;
                a.download = "grabacion.wav";
                a.textContent = "Descargar Grabación";
                document.body.appendChild(a);
                logTrace("Grabación lista para descargar.");
            };

            mediaRecorder.start();
            isRecording = true;
            document.getElementById("stop-recording-button").disabled = false;

            hideExtraControls = true;
            document.getElementById("extra-controls").style.opacity = "0";

            videoElement.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
            logTrace("Video despausado y sincronizado con la grabación.");

        } catch (error) {
            logTrace(`Error al acceder al micrófono: ${error.message}`);
        }
    });

    function stopRecording() {
        if (isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            logTrace("Grabación detenida manualmente.");
            videoElement.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            hideExtraControls = false;
            document.getElementById("extra-controls").style.opacity = "1";
            document.getElementById("stop-recording-button").disabled = true;
        }
    }

    document.getElementById("stop-recording-button").addEventListener("click", stopRecording);

    window.addEventListener("resize", () => {
        logTrace("Detectado cambio de orientación.");
    });

</script>

</body>
</html>
