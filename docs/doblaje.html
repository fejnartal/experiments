<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronización de Audio con YouTube</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; }
        #video-container { width: 100%; max-width: 800px; margin: auto; position: relative; }
        iframe { width: 100%; height: 450px; }
        #countdown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); color: white; display: flex;
            justify-content: center; align-items: center; font-size: 5rem;
            font-weight: bold; display: none; z-index: 1000;
        }
    </style>
</head>
<body>

<div id="video-container"></div>

<div>
    <input type="text" id="youtube-url" placeholder="Pega la URL de YouTube aquí">
    <button id="load-video">Cargar Video</button>
</div>

<div id="countdown-overlay"></div>

<script>
    let player;
    let mediaRecorder, stream;
    let isRecording = false;
    let isCountdownActive = false; // Nueva variable para evitar bucles
    let lastPlayTimestamp = 0;
    let ignoreNextStateChange = false;

    function getYouTubeVideoId(url) {
        const regExp = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }

    function loadYouTubeVideo(videoId) {
        if (!videoId) return console.error("Error: ID de video no válido.");

        document.getElementById("video-container").innerHTML = `<div id="player"></div>`;

        player = new YT.Player("player", {
            height: "450",
            width: "100%",
            videoId: videoId,
            events: {
                "onStateChange": onPlayerStateChange
            }
        });
    }

    async function prepareRecording() {
        try {
            if (!stream) {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            }
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    console.log("Grabación guardada.");
                }
            };
            console.log("MediaRecorder listo.");
        } catch (error) {
            console.error(`Error al acceder al micrófono: ${error.message}`);
        }
    }

    function startRecording() {
        if (isRecording) return;
        mediaRecorder.start();
        isRecording = true;
    }

    function stopRecording() {
        if (isRecording) {
            mediaRecorder.stop();
            isRecording = false;
        }
    }

    function showCountdown(callback) {
        if (isCountdownActive) return; // Evita múltiples cuentas atrás
        isCountdownActive = true;

        const countdownOverlay = document.getElementById("countdown-overlay");
        countdownOverlay.style.display = "flex";

        let countdown = 3;
        countdownOverlay.textContent = countdown;

        const countdownInterval = setInterval(() => {
            countdown--;
            countdownOverlay.textContent = countdown;

            if (countdown === 0) {
                clearInterval(countdownInterval);
                countdownOverlay.style.display = "none";
                isCountdownActive = false; // Restablecer para futuras ejecuciones
                callback();
            }
        }, 1000);
    }

    function onPlayerStateChange(event) {
        if (ignoreNextStateChange) {
            ignoreNextStateChange = false;
            return;
        }

        if (event.data === YT.PlayerState.PLAYING) {
            console.log("El video ha comenzado a reproducirse.");

            if (isCountdownActive) return; // Evita que la cuenta atrás se inicie nuevamente

            lastPlayTimestamp = player.getCurrentTime();
            player.pauseVideo();

            showCountdown(async () => {
                await prepareRecording();
                ignoreNextStateChange = true; // Evita que PLAYING vuelva a activar otra cuenta atrás
                player.seekTo(lastPlayTimestamp, true);
                player.playVideo();
                startRecording();
            });

        } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
            console.log("El video se ha pausado o terminado.");
            stopRecording();
        }
    }

    document.getElementById("load-video").addEventListener("click", function () {
        const url = document.getElementById("youtube-url").value;
        const videoId = getYouTubeVideoId(url);
        if (videoId) {
            loadYouTubeVideo(videoId);
        } else {
            console.error("URL de YouTube no válida.");
        }
    });
</script>

</body>
</html>
