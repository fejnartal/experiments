<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronización de Audio con YouTube</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; }
        #video-container { width: 100%; max-width: 800px; margin: auto; position: relative; }
        iframe { width: 100%; height: 450px; }
        #controls-container { position: sticky; bottom: 0; background: white; padding: 10px; }
        .controls button { padding: 10px; font-size: 16px; margin: 5px; }
        #timestamp { 
            font-size: 2rem; font-weight: bold; color: white; background: rgba(0, 0, 0, 0.5);
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 5px 10px;
            z-index: 999;
        }
        #recordings-list { margin-top: 20px; }
        .recording-item { margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="timestamp">0:00:00.000</div>
<div id="video-container"></div>

<div id="controls-container">
    <button id="record-button" disabled>Grabar</button>
    <button id="stop-recording-button" disabled>Detener</button>
    <label>
        <input type="checkbox" id="disable-recording"> Deshabilitar grabación
    </label>
</div>

<h1>Sincronización de Audio con YouTube</h1>

<div>
    <input type="text" id="youtube-url" placeholder="Pega la URL de YouTube aquí">
    <button id="load-video">Cargar Video</button>
</div>

<h2>Grabaciones</h2>
<div id="recordings-list"></div>

<script>
    let player;
    let mediaRecorder, stream;
    let isRecording = false;
    let audioChunks = [];
    let recordings = [];
    let currentRecordingStartTime = 0;

    function logTrace(message) {
        console.log(message);
    }

    function getYouTubeVideoId(url) {
        const regExp = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }

    function loadYouTubeVideo(videoId, startTime) {
        if (!videoId) return logTrace("Error: ID de video no válido.");
        
        document.getElementById("video-container").innerHTML = `<div id="player"></div>`;

        player = new YT.Player("player", {
            height: "450",
            width: "100%",
            videoId: videoId,
            playerVars: { start: startTime },
            events: {
                "onStateChange": onPlayerStateChange
            }
        });

        document.getElementById("record-button").disabled = false;
    }

    function onPlayerStateChange(event) {
        const disableRecordingCheckbox = document.getElementById("disable-recording");

        if (event.data === YT.PlayerState.PLAYING) {
            logTrace("El video ha comenzado a reproducirse.");
            disableRecordingCheckbox.disabled = true; // Bloqueamos el checkbox mientras el video se reproduce

            if (!disableRecordingCheckbox.checked) {
                startRecording();
            }

            playSyncedRecordings();
        } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
            logTrace("El video se ha pausado o terminado.");
            disableRecordingCheckbox.disabled = false; // Desbloqueamos el checkbox
            stopRecording();
            stopAllRecordings();
        }
    }

    async function startRecording() {
        if (isRecording) return logTrace("Ya hay una grabación en curso.");

        try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            currentRecordingStartTime = player.getCurrentTime(); // Guardamos el timestamp del video

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.start();
            isRecording = true;
            document.getElementById("stop-recording-button").disabled = false;
        } catch (error) {
            logTrace(`Error al acceder al micrófono: ${error.message}`);
        }
    }

    function stopRecording() {
        if (isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById("stop-recording-button").disabled = true;
            addAudioToList();
        }
    }

    function addAudioToList() {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        const timestamp = currentRecordingStartTime;

        recordings.push({ url: audioUrl, timestamp });

        const recordingsList = document.getElementById("recordings-list");
        const div = document.createElement("div");
        div.classList.add("recording-item");

        const audioElement = document.createElement("audio");
        audioElement.src = audioUrl;
        audioElement.controls = true;

        const timestampLabel = document.createElement("span");
        timestampLabel.textContent = `📌 Timestamp: ${timestamp.toFixed(2)}s `;

        const downloadButton = document.createElement("button");
        downloadButton.textContent = "Descargar";
        downloadButton.onclick = () => {
            const a = document.createElement("a");
            a.href = audioUrl;
            a.download = `grabacion_${new Date().toISOString()}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        const playCheckbox = document.createElement("input");
        playCheckbox.type = "checkbox";
        playCheckbox.checked = true;
        playCheckbox.onchange = () => {
            if (!playCheckbox.checked) {
                audioElement.pause();
            }
        };

        div.appendChild(timestampLabel);
        div.appendChild(audioElement);
        div.appendChild(downloadButton);
        div.appendChild(playCheckbox);
        recordingsList.appendChild(div);
    }

    function playSyncedRecordings() {
        const currentTime = player.getCurrentTime();
        recordings.forEach(({ url, timestamp }) => {
            if (currentTime >= timestamp) {
                const audio = new Audio(url);
                audio.play();
            }
        });
    }

    function stopAllRecordings() {
        document.querySelectorAll("audio").forEach(audio => audio.pause());
    }

    document.getElementById("load-video").addEventListener("click", function () {
        const url = document.getElementById("youtube-url").value;
        const videoId = getYouTubeVideoId(url);
        if (videoId) {
            loadYouTubeVideo(videoId, 0);
        } else {
            logTrace("URL de YouTube no válida.");
        }
    });
</script>

</body>
</html>
