<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronización de Audio con YouTube</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; }
        #video-container { width: 100%; max-width: 800px; margin: auto; position: relative; }
        iframe { width: 100%; height: 450px; }
        #controls-container { position: sticky; bottom: 0; background: white; padding: 10px; }
        .controls button { padding: 10px; font-size: 16px; margin: 5px; }
        #timestamp { 
            font-size: 2rem; font-weight: bold; color: white; background: rgba(0, 0, 0, 0.5);
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 5px 10px;
            z-index: 999; /* Asegura que el temporizador esté encima del video */
        }
        #error-log { display: none; background: #ffcccc; padding: 10px; margin-top: 10px; border-radius: 5px; color: #cc0000; }
    </style>
</head>
<body>

<div id="video-container">
    <div id="timestamp">0:00:00.000</div>
</div>

<div id="controls-container">
    <button id="play-button" disabled>Reproducir</button>
    <button id="record-button" disabled>Grabar</button>
    <button id="stop-recording-button" disabled>Detener</button>
</div>

<h1>Sincronización de Audio con YouTube</h1>

<div>
    <input type="text" id="youtube-url" placeholder="Pega la URL de YouTube aquí">
    <button id="load-video">Cargar Video</button>
    <button id="generate-url-button">Generar URL</button>
    <input type="text" id="generated-url" readonly>
</div>

<div id="error-log"></div>

<script>
    let mediaRecorder, videoElement, player, timestampInterval;
    let isRecording = false, isPlaying = false, audioChunks = [];
    let videoId = "", startTime = 0;
    
    function logTrace(message) {
        console.log(message);
        const errorLog = document.getElementById("error-log");
        errorLog.style.display = 'block';
        errorLog.textContent += `${new Date().toLocaleTimeString()}: ${message}\n`;
    }

    function getYouTubeVideoId(url) {
        const regExp = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }

    function loadYouTubeVideo(id, start) {
        if (!id) return logTrace("Error: ID de video no válido.");
        videoId = id;
        startTime = start;

        logTrace(`Cargando video con ID: ${videoId} y tiempo: ${startTime}`);

        let videoContainer = document.getElementById("video-container");
        // Mantener el contenedor del temporizador y agregar el iframe sin eliminar el temporizador
        videoContainer.innerHTML = `
            <iframe id="video" src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&start=${startTime}" 
                frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        `;

        videoElement = document.getElementById("video");

        document.getElementById("play-button").disabled = false;
        document.getElementById("record-button").disabled = false;
        document.getElementById("stop-recording-button").disabled = false;
    }

    function updateTimestamp() {
        if (!videoElement) return;

        videoElement.contentWindow.postMessage('{"event":"command","func":"getCurrentTime","args":""}', "*");
    }

    window.addEventListener("message", (event) => {
        if (event.data && event.data.event === "infoDelivery" && event.data.info && typeof event.data.info.currentTime === "number") {
            let time = event.data.info.currentTime;
            let minutes = Math.floor(time / 60);
            let seconds = Math.floor(time % 60);
            let milliseconds = Math.floor((time % 1) * 1000);
            document.getElementById("timestamp").textContent = `${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds}`;
        }
    });

    document.getElementById("load-video").addEventListener("click", function () {
        const url = document.getElementById("youtube-url").value;
        const id = getYouTubeVideoId(url);
        const timeMatch = url.match(/[?&]t=(\d+)[m]?(\d+)?[s]?/);
        const start = timeMatch ? (parseInt(timeMatch[1]) || 0) + (parseInt(timeMatch[2] || 0) * 60) : 0;

        if (id) {
            loadYouTubeVideo(id, start);
        } else {
            logTrace("URL de YouTube no válida.");
        }
    });

    document.getElementById("play-button").addEventListener("click", function () {
        if (!videoElement) return logTrace("Error: No hay video cargado.");
        
        videoElement.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', "*");
        isPlaying = true;
        logTrace("Reproduciendo video.");
        timestampInterval = setInterval(updateTimestamp, 100);
    });

    document.getElementById("record-button").addEventListener("click", async function () {
        if (isRecording) return logTrace("Ya hay una grabación en curso.");

        if (!videoId) return logTrace("Error: No hay un video cargado.");

        try {
            logTrace("Solicitando permiso para el micrófono...");
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            logTrace("Permiso concedido. Reiniciando video y comenzando grabación...");

            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.start();
            isRecording = true;
            document.getElementById("stop-recording-button").disabled = false;

            loadYouTubeVideo(videoId, startTime);
            setTimeout(() => {
                videoElement.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', "*");
            }, 1000);
        } catch (error) {
            logTrace(`Error al acceder al micrófono: ${error.message}`);
        }
    });

    document.getElementById("stop-recording-button").addEventListener("click", function () {
        if (isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById("stop-recording-button").disabled = true;
        }

        if (isPlaying) {
            videoElement.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', "*");
            logTrace("Pausando video.");
            clearInterval(timestampInterval);
            isPlaying = false;
        }
    });

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("video");
        const start = params.get("start");

        if (id) {
            loadYouTubeVideo(id, parseInt(start) || 0);
        }
    }

    checkUrlParams();
</script>

</body>
</html>
